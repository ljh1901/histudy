<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.histudy.lms">
	<select id="studyCreatorCheck" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT *
		FROM study
		WHERE user_idx=#{user_idx} and study_status!=2
	</select>
	<select id="studyApplyCheck" parameterType="Integer" resultType="com.histudy.study.model.StudyApplyDTO">
		SELECT sa.*
		FROM study_application sa JOIN study s ON sa.study_idx = s.study_idx
		WHERE sa.user_idx = #{user_idx} and sa.sa_status = 'Approved' and s.study_status!=2
	</select>
	<select id="studyApproved" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT *
		FROM study
		WHERE study_idx = #{study_idx} and study_status!=2
	</select>
	<insert id="insertTask" parameterType="com.histudy.lms.model.LmsDTO">
		INSERT INTO assignment VALUES(a_idx.nextval, #{a_title}, #{a_content}, #{a_fname}, sysdate, TO_DATE(#{a_end_date}, 'YYYY-MM-DD hh24:mi'), #{a_weeks}, #{user_idx}, #{study_idx})
	</insert>
	<select id="selectStudyCreatorTask" parameterType="Integer" resultType="com.histudy.lms.model.LmsDTO">
		SELECT a.*, s.study_title
		FROM study s JOIN assignment a ON s.study_idx = a.study_idx
		WHERE s.user_idx=#{user_idx} and a.a_end_date > sysdate and s.study_status != 2
	</select>
	<select id="selectStudyApprovedTask" parameterType="Integer" resultType="com.histudy.lms.model.LmsDTO">
		SELECT a.*, s.study_title
		FROM study s JOIN assignment a ON s.study_idx = a.study_idx
		WHERE s.study_idx in 
		                (SELECT study_idx 
		                 FROM study_application
		                 WHERE user_idx = #{user_idx} and sa_status = 'Approved') 
		and a.a_idx not in
		                (SELECT a_idx
		                 FROM assignment_submit
		                 WHERE user_idx = #{user_idx})
		and a.a_end_date > sysdate and s.study_status != 2
	</select>
	<select id="selectTask" parameterType="Integer" resultType="com.histudy.lms.model.LmsDTO">
		SELECT *
		FROM assignment
		WHERE a_idx=#{a_idx}
	</select>
	<select id="waitTaskCount" parameterType="Integer" resultType="Integer">
		SELECT count(*)
		FROM study s JOIN assignment a ON s.study_idx = a.study_idx
		WHERE s.study_idx in
		                (SELECT study_idx 
		                 FROM study_application
		                 WHERE user_idx = #{user_idx} and sa_status = 'Approved') 
		and a.a_idx not in
		                (SELECT a_idx
		                 FROM assignment_submit
		                 WHERE user_idx = #{user_idx})
		and a.a_end_date > sysdate
	</select>
	<select id="taskSubmitOkCount" parameterType="Integer" resultType="Integer">
		SELECT count(*)
		FROM assignment_submit
		WHERE user_idx = #{user_idx}
	</select>
	<select id="myStudyInTaskCount" parameterType="Integer" resultType="Integer">
		SELECT count(*)
		FROM assignment
		WHERE study_idx = #{study_idx} and a_end_date > sysdate
	</select>
	<select id="memberStudyInTaskCount" parameterType="map" resultType="Integer">
		SELECT count(*)
		FROM assignment
		WHERE study_idx = #{study_idx} 
		    and a_idx not in
		                       (
		                       SELECT a_idx
		                       FROM assignment_submit
		                       WHERE user_idx = #{user_idx}
		                       )
		    and a_end_date > SYSDATE
	</select>
	<update id="taskInsertUpdate" parameterType="com.histudy.lms.model.LmsDTO">
		UPDATE assignment
		SET a_title=#{a_title}, a_content=#{a_content},
		    a_fname=#{a_fname}, a_end_date=TO_DATE(#{a_end_date}, 'YYYY-MM-DD HH24:MI'),
		    a_weeks=#{a_weeks}
		WHERE a_idx=#{a_idx}
	</update>
	<select id="selectStudyData" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT u.user_name, s.study_idx, s.user_idx, s.study_title, s.study_current_members, s.study_max_members, s.study_begin_date, s.study_total_weeks, sysdate, sc.sc_name
		FROM study s JOIN study_category sc ON s.sc_idx = sc.sc_idx JOIN usertb u ON s.user_idx = u.user_idx
		WHERE s.study_idx = #{study_idx}   
	</select>
	<select id="memberData" parameterType="Integer" resultType="com.histudy.study.model.StudyApplyDTO">
		SELECT sa.*, u.user_name, u.user_email, u.user_idx 
		FROM study_application sa JOIN usertb u ON sa.user_idx = u.user_idx
		WHERE sa.sa_status='Approved' and study_idx = #{study_idx}
	</select>
	<select id="studyApplicationUser" parameterType="Integer" resultType="com.histudy.study.model.StudyApplyDTO">
		SELECT sa.*, u.user_name, u.user_email 
		FROM study_application sa JOIN usertb u ON sa.user_idx = u.user_idx
		WHERE sa.sa_status='Pending' and study_idx = #{study_idx}
	</select>
	<update id="studyApplicationApproved" parameterType="map">
		UPDATE study_application
		SET sa_status='Approved', join_date = sysdate
		WHERE study_idx = #{study_idx} and user_idx=#{user_idx}
	</update>
	<update id="studyApplicationReject" parameterType="map">
		UPDATE study_application
		SET sa_status='Reject', sa_reason = #{sa_reason}
		WHERE study_idx=#{study_idx} and user_idx=#{user_idx}
	</update>
	<select id="studyCreatorData" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT s.*, u.user_name, u.user_email 
		FROM study s JOIN usertb u ON s.user_idx = u.user_idx
		WHERE s.study_idx = #{study_idx}
	</select>
	<select id="taskTotalCount" parameterType="Integer" resultType="Integer">
		SELECT count(*)
		FROM assignment
		WHERE study_idx = #{study_idx}
	</select>
	<select id="taskSubmitCount" parameterType="map" resultType="Integer">
		SELECT count(*)
		FROM assignment a JOIN assignment_submit ass ON a.a_idx = ass.a_idx
		WHERE a.study_idx = #{study_idx} and ass.user_idx = #{user_idx}
	</select>
	<delete id="deleteStudyMember" parameterType="map">
		DELETE FROM study_application where sa_status='Approved' and user_idx=#{user_idx} and study_idx=#{study_idx}
	</delete>
	<select id="studyDateCheck" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT study_begin_date, sysdate
		FROM study
		WHERE study_idx=#{study_idx}
	</select>
	<update id="studyStatusUpdate" parameterType="map">
		UPDATE study
		SET study_status = #{study_status}
		WHERE study_idx=#{study_idx}
	</update>
	<select id="finishStudy" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT s.*, u.user_name
		FROM study s
		JOIN usertb u ON s.user_idx = u.user_idx
		WHERE s.study_status = 2
		  AND s.user_idx = #{user_idx}
		
		UNION
		
		SELECT s.*, u.user_name
		FROM study s
		JOIN study_application sa ON s.study_idx = sa.study_idx
		JOIN usertb u ON s.user_idx = u.user_idx
		WHERE s.study_status = 2
		  AND sa.user_idx = #{user_idx}
		  AND sa.sa_status = 'Approved'
	</select>
	<select id="selectMemberNum" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT study_current_members, study_max_members
		FROM study
		WHERE study_idx = #{study_idx}
	</select>
	<update id="currentMembersUpdate" parameterType="map">
		UPDATE study
		SET study_current_members=#{study_current_members}
		WHERE study_idx = #{study_idx}
	</update>
	
	<!-- LmsRestController에서 쓰는 DAO -->
	<select id="lmsRestLeaderSelectTask" parameterType="map" resultType="com.histudy.lms.model.LmsDTO">
		SELECT a.*, s.study_title
		FROM study s JOIN assignment a ON s.study_idx = a.study_idx
		WHERE s.user_idx=#{user_idx} and s.study_idx=#{study_idx} and a.a_end_date > sysdate
	</select>
	<select id="lmsRestMemberSelectTask" parameterType="map" resultType="com.histudy.lms.model.LmsDTO">
		SELECT a.*, s.study_title
		FROM study s JOIN assignment a ON s.study_idx = a.study_idx
		WHERE s.study_idx = #{study_idx}
		and a.a_idx not in
		                (SELECT a_idx
		                 FROM assignment_submit
		                 WHERE user_idx = #{user_idx})
		and a.a_end_date > sysdate
	</select>
	<select id="assignmentSubmitOk" parameterType="Integer" resultType="com.histudy.lms.model.LmsDTO">
		SELECT a.*, s.study_title
		FROM study s JOIN assignment a ON s.study_idx = a.study_idx
		WHERE s.study_idx in 
		                (SELECT study_idx 
		                 FROM study_application
		                 WHERE user_idx = #{user_idx} and sa_status = 'Approved') 
		and a.a_idx in
		                (SELECT a_idx
		                 FROM assignment_submit
		                 WHERE user_idx = #{user_idx})
		and a.a_end_date > SYSDATE
	</select>
	
	<!-- LmsSubmitDAO에서 쓰는 쿼리 -->
	<!-- 과제 제출  -->
	<select id="insertTaskSubmit" parameterType="com.histudy.lms.model.LmsSubmitDTO">
		INSERT INTO assignment_submit VALUES(as_idx.nextval, #{as_content}, #{as_fname}, #{as_status}, sysdate, #{as_update_date}, #{user_idx}, #{a_idx})
	</select>
	<!-- 제출한 과제 수정 -->
	<update id="taskSubmitUpdate" parameterType="com.histudy.lms.model.LmsSubmitDTO">
		UPDATE assignment_submit
		SET as_content=#{as_content}, as_fname=#{as_fname},
			as_status='update', as_update_date=sysdate
		WHERE a_idx = #{a_idx}
	</update>
	<!-- 해당 과제의 과제 제출 조회 -->
	<select id="selectAssignmentSubmit" parameterType="Integer" resultType="com.histudy.lms.model.LmsSubmitDTO">
		SELECT *
		FROM assignment_submit
		WHERE a_idx = #{a_idx}
	</select>
	
	<update id="userLoginTimeUpdate" parameterType="Integer">
		UPDATE study_application
		SET login_time = sysdate
		WHERE user_idx=#{user_idx} and sa_status='Approved'
	</update>
	<update id="userLogoutTimeUpdate" parameterType="Integer">
		UPDATE study_application
		SET logout_time = sysdate
		WHERE user_idx=#{user_idx} and sa_status='Approved'
	</update>
</mapper>