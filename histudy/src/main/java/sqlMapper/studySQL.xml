<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.histudy.study">
   <insert id="insertStudy" parameterType="com.histudy.study.model.StudyDTO">
      INSERT INTO study values(study_idx.nextval, #{study_title}, #{study_content}, sysdate, #{study_end_date},
                               1, #{study_max_members}, #{study_location_lng}, #{study_location_lat}, #{study_addr},
                               #{study_upload_img}, #{sc_idx}, #{user_idx}, null, #{study_total_weeks})
   </insert>
   <select id="selectStudyList" parameterType="map" resultType="com.histudy.study.model.StudyDTO">
      SELECT * 
            FROM
                (SELECT rownum as rnum, a.*
               FROM 
                 (
                  SELECT study.*, usertb.user_name, study_category.sc_name
                  FROM study JOIN usertb ON study.user_idx=usertb.user_idx JOIN study_category ON study_category.sc_idx = study.sc_idx
                  <if test="sc_idx != null">
                  	WHERE study_category.sc_idx=#{sc_idx} 
                  </if>
                  ORDER BY study_idx desc
                 ) a ) b
      WHERE rnum between #{start_num} and #{end_num}
   </select>
   <select id="studyTotalCnt" parameterType="Integer" resultType="Integer">
      SELECT count(*)
      FROM study
      <if test="sc_idx != null">
      		WHERE sc_idx=#{sc_idx}
      </if>
   </select>
   <select id="studyCreateUser" parameterType="Integer" resultType="com.histudy.user.model.UserDTO">
      SELECT user_name, user_email, user_tel
      FROM usertb
      WHERE user_idx=#{user_idx}
   </select>
   <select id="studyMaxCreate" parameterType="Integer" resultType="Integer">
      SELECT count(*)
      FROM study JOIN usertb ON study.user_idx=usertb.user_idx
      WHERE study.user_idx=#{user_idx}
   </select>
   <select id="selectStudyContent" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT a.study_idx, a.study_title, a.study_content,
		       a.study_end_date, a.study_current_members, a.study_max_members,
		       a.study_location_lng, a.study_location_lat, a.study_addr,
		       a.study_upload_img, a.sc_idx, a.user_idx, a.user_name,
		       study_category.sc_name, TO_CHAR(a.study_start_date, 'YYYY-MM-DD') as study_start_date,
		       a.study_total_weeks
		FROM
		    (
		    select study.*, usertb.user_name
		    from study JOIN usertb ON study.user_idx=usertb.user_idx
		    where study_idx = #{study_idx}
		    ) a JOIN study_category ON a.sc_idx = study_category.sc_idx
   </select>
</mapper>
