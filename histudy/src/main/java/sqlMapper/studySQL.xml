<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.histudy.study">
   <!-- StudyDAO -->
   <!-- 스터디 개설 -->
   <insert id="insertStudy" parameterType="com.histudy.study.model.StudyDTO">
      INSERT INTO study values(study_idx.nextval, #{study_title}, #{study_content}, sysdate, #{study_end_date},
                               1, #{study_max_members}, #{study_location_lng}, #{study_location_lat}, #{study_addr},
                               #{study_upload_img}, #{sc_idx}, #{user_idx}, #{study_begin_date}, #{study_total_weeks}, 0)
   </insert>
   
   <!-- 스터디 리스트 조회 -->
   <select id="selectStudyList" parameterType="map" resultType="com.histudy.study.model.StudyDTO">
      SELECT *
            FROM
                (SELECT rownum as rnum, a.*
               FROM 
                 (
                  SELECT study.*, usertb.user_name, study_category.sc_name, TRUNC(study_end_date) - TRUNC(sysdate) AS dday
                  FROM study JOIN usertb ON study.user_idx=usertb.user_idx JOIN study_category ON study_category.sc_idx = study.sc_idx
			        <where>
			            TRUNC(study_end_date) >= TRUNC(sysdate)
			
			            <if test="sc_idx != null">
			                AND study_category.sc_idx = #{sc_idx}
			            </if>
			
			            <if test="studyFind != null and sc_idx == null">
			                AND study_title LIKE '%' || #{studyFind} || '%'
			            </if>	
			        </where>
                  ORDER BY study_idx desc
                 ) a ) b
      WHERE rnum between #{start_num} and #{end_num}
   </select>
   
   <!-- 스터디 총 갯수 (페이징 시 필요)-->
   <select id="studyTotalCnt" parameterType="Integer" resultType="Integer">
      SELECT count(*)
      FROM study
      <where>
	      	TRUNC(study_end_date) >= TRUNC(sysdate)
	      	
	      	<if test="sc_idx != null">
	      		and sc_idx=#{sc_idx}
	        </if>
      </where>
   </select>
   
   <!-- 스터디 개설 페이지 이동 시 로그인된 사용자 정보 조회 -->
   <select id="studyCreateUser" parameterType="Integer" resultType="com.histudy.user.model.UserDTO">
      SELECT user_name, user_email, user_tel
      FROM usertb
      WHERE user_idx=#{user_idx}
   </select>
   
   <!-- 스터디 개설 갯수 총 3개 제한을 두기 위한 count(*)조회  -->
   <select id="studyMaxCreate" parameterType="Integer" resultType="Integer">
      SELECT count(*)
      FROM study JOIN usertb ON study.user_idx=usertb.user_idx
      WHERE study.user_idx=#{user_idx} and study_status != 2
   </select>
   
   <!-- 스터디 내용 페이지 입장 시 필요한 데이터 조회 -->
   <select id="selectStudyContent" parameterType="Integer" resultType="com.histudy.study.model.StudyDTO">
		SELECT a.study_idx, a.study_title, a.study_content,
		       a.study_end_date, a.study_current_members, a.study_max_members,
		       a.study_location_lng, a.study_location_lat, a.study_addr,
		       a.study_upload_img, a.sc_idx, a.user_idx, a.user_name,
		       study_category.sc_name, TO_CHAR(a.study_start_date, 'YYYY-MM-DD') as study_start_date,
		       a.study_total_weeks, a.study_begin_date
		FROM
		    (
		    select study.*, usertb.user_name
		    from study JOIN usertb ON study.user_idx=usertb.user_idx
		    where study_idx = #{study_idx}
		    ) a JOIN study_category ON a.sc_idx = study_category.sc_idx
   </select>
   
   <!-- 스터디 검색 시 디비에 저장되어 있는 모든 스터디 제목 조회 -->
   <select id="studyTitleFind" resultType="com.histudy.study.model.StudyDTO">
   		SELECT study_title
   		FROM study
   </select>
   
   <!-- 검색 결과가 몇개인지 총 갯수 조회  -->
   <select id="studyTitleSearchTotalCnt" parameterType="String" resultType="Integer">
   	  SELECT count(*)
   	  FROM study
   	  WHERE study_title LIKE '%' || #{studyFind} || '%'
   </select>
   
   <!-- StudyApplyDAO -->
   <!--  스터디 신청  -->
   <insert id="StudyApply" parameterType="com.histudy.study.model.StudyApplyDTO">
   		INSERT INTO study_application VALUES(sa_idx.nextval, #{sa_intro}, #{sa_status}, #{sa_reason}, #{user_idx}, #{study_idx}, null, null, null)
   </insert>
   
   <!-- 스터디 신청 버튼 눌렀을 때 중복 방지용 -->
   <select id="StudyApplyCheck" parameterType="map" resultType="Integer">
		SELECT count(*) 
		FROM study_application
		WHERE (sa_status = 'Pending' and user_idx=#{user_idx} and study_idx = #{study_idx}) or (sa_status='Approved' and user_idx = #{user_idx} and study_idx = #{study_idx})
   </select>
   
   <!-- 자신이 개설한 스터디에 신청을 막기 위함 -->
   <select id="StudyApplyCheck2" parameterType="Integer" resultType="Integer">
		select user_idx
		from study 
		where study_idx = #{study_idx}
   </select>
</mapper>
